<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ—Ñ–ª–µ–∫—Å–∏—è –ï–ê–û ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');

        :root {
            --sun: #FFD93D;
            --cloud: #94A3B8;
            --rain: #38BDF8;
            --accent: #6366F1;
            --bg: #0F172A;
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            margin: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            background-image: radial-gradient(circle at 0% 0%, #1e1b4b 0%, transparent 50%),
                              radial-gradient(circle at 100% 100%, #1e293b 0%, transparent 50%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            display: none;
            height: 100vh;
            width: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .screen.active { display: flex; animation: fadeIn 0.6s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –º–µ–Ω—é */
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 32px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-width: 450px;
            width: 100%;
        }

        h1 { font-weight: 800; font-size: 2.2rem; margin-bottom: 8px; letter-spacing: -1px; }
        p.subtitle { color: #94A3B8; margin-bottom: 32px; font-size: 0.95rem; }

        .btn-role {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-role:hover {
            background: var(--accent);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É—á–µ–Ω–∏–∫–∞ */
        .reaction-list { width: 100%; max-width: 400px; }
        .reaction-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .reaction-item:hover { background: rgba(255, 255, 255, 0.08); transform: scale(1.02); }
        .reaction-item .icon { font-size: 2.5rem; }
        .reaction-item h3 { margin: 0; font-size: 1.1rem; }
        .reaction-item p { margin: 4px 0 0; font-size: 0.85rem; color: #94A3B8; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É—á–∏—Ç–µ–ª—è */
        .teacher-layout {
            width: 95%;
            max-width: 1200px;
            height: 85vh;
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 20px;
            text-align: center;
        }

        .stat-card b { font-size: 1.5rem; display: block; margin-top: 5px; }

        .map-viewport {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 24px;
        }

        .jao-shape {
            fill: rgba(99, 102, 241, 0.05);
            stroke: var(--accent);
            stroke-width: 1.5;
        }

        .dot {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.7; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .back-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            background: none;
            border: none;
            color: #94A3B8;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover { color: white; }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π –∞–ª–µ—Ä—Ç */
        #alert {
            position: fixed;
            bottom: 30px;
            background: var(--accent);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transform: translateY(100px);
            transition: 0.5s;
        }
        #alert.show { transform: translateY(0); }

    </style>
</head>
<body>

    <div id="alert">–ì–æ–ª–æ—Å —É—á—Ç–µ–Ω! ‚ú®</div>

    <!-- MAIN -->
    <div id="screen-main" class="screen active">
        <div class="glass-card">
            <h1>–†–µ—Ñ–ª–µ–∫—Å–∏—è –ï–ê–û</h1>
            <p class="subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Ä–æ–∫–∞</p>
            <button class="btn-role" onclick="changeScreen('student')">üë®‚Äçüéì –Ø —É—á–µ–Ω–∏–∫</button>
            <button class="btn-role" onclick="changeScreen('teacher')">üë©‚Äçüè´ –Ø —É—á–∏—Ç–µ–ª—å</button>
        </div>
    </div>

    <!-- STUDENT -->
    <div id="screen-student" class="screen">
        <button class="back-btn" onclick="changeScreen('main')">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
        <h2 style="font-size: 1.8rem; margin-bottom: 30px;">–ö–∞–∫ —Ç–µ–±–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —É—Ä–æ–∫?</h2>
        <div class="reaction-list">
            <div class="reaction-item" onclick="send('sun')">
                <span class="icon">‚òÄÔ∏è</span>
                <div>
                    <h3>–í—Å—ë —Å—É–ø–µ—Ä!</h3>
                    <p>–ú–Ω–µ –±—ã–ª–æ –ª–µ–≥–∫–æ –∏ –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ</p>
                </div>
            </div>
            <div class="reaction-item" onclick="send('cloud')">
                <span class="icon">‚õÖ</span>
                <div>
                    <h3>–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã</h3>
                    <p>–Ø —Å—Ç–∞—Ä–∞–ª—Å—è, –Ω–æ –Ω—É–∂–Ω–æ –µ—â—ë —Ä–∞–∑–æ–∫ —Ä–∞–∑–æ–±—Ä–∞—Ç—å</p>
                </div>
            </div>
            <div class="reaction-item" onclick="send('rain')">
                <span class="icon">üåßÔ∏è</span>
                <div>
                    <h3>–ë—ã–ª–æ —Å–ª–æ–∂–Ω–æ</h3>
                    <p>–ú–Ω–µ —Ç—è–∂–µ–ª–æ –¥–∞–ª–∞—Å—å —ç—Ç–∞ —Ç–µ–º–∞</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TEACHER -->
    <div id="screen-teacher" class="screen">
        <button class="back-btn" onclick="changeScreen('main')">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
        <div class="teacher-layout">
            <div class="stats-grid">
                <div class="stat-card" style="color: var(--sun)">‚òÄÔ∏è –£—Å–ø–µ—Ö <b id="s-count">0</b></div>
                <div class="stat-card" style="color: var(--cloud)">‚õÖ –í–æ–ø—Ä–æ—Å—ã <b id="c-count">0</b></div>
                <div class="stat-card" style="color: var(--rain)">üåßÔ∏è –¢—Ä—É–¥–Ω–æ—Å—Ç–∏ <b id="r-count">0</b></div>
            </div>
            <div class="map-viewport">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let mapInstance = null;
        let markers = [];
        
        const colors = {
            'sun': '#FFD93D',
            'cloud': '#94A3B8',
            'rain': '#38BDF8'
        };
        const emojis = {
            'sun': '‚òÄÔ∏è',
            'cloud': '‚õÖ',
            'rain': 'üåßÔ∏è'
        };

        function changeScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            if(id === 'teacher') {
                setTimeout(() => {
                    if(!mapInstance) initMap();
                    refresh();
                }, 100);
            }
        }

        function initMap() {
            mapInstance = L.map('map').setView([48.5, 132.5], 8);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 12,
                minZoom: 7
            }).addTo(mapInstance);
        }

        async function send(type) {
            const x = 35 + Math.random() * 30;
            const y = 35 + Math.random() * 30;
            
            try {
                await fetch('/api/react', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type, x, y })
                });
                
                const alertBox = document.getElementById('alert');
                alertBox.classList.add('show');
                setTimeout(() => {
                    alertBox.classList.remove('show');
                    changeScreen('main');
                }, 1500);
            } catch(e) { console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
        }

        async function refresh() {
            try {
                const res = await fetch('./data.json');
                const data = await res.json();
                
                document.getElementById('s-count').innerText = data.sun;
                document.getElementById('c-count').innerText = data.cloud;
                document.getElementById('r-count').innerText = data.rain;

                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                markers.forEach(m => mapInstance.removeLayer(m));
                markers = [];
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                if(data.dots && Array.isArray(data.dots)) {
                    data.dots.forEach((d) => {
                        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö: X –∏ Y –æ—Ç ~36 –¥–æ ~64
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ï–ê–û
                        // –ï–ê–û: —à–∏—Ä–æ—Ç–∞ 46.1-49.3¬∞, –¥–æ–ª–≥–æ—Ç–∞ 129.0-135.5¬∞
                        const lat = 46.1 + ((d.y - 36) / 28) * 3.2;
                        const lng = 129.0 + ((d.x - 36) / 28) * 6.5;
                        
                        const icon = L.divIcon({
                            html: `<div style="text-align: center; font-size: 4rem; text-shadow: 0 0 15px ${colors[d.type]}; line-height: 1;">${emojis[d.type]}</div>`,
                            iconSize: [80, 80],
                            iconAnchor: [40, 40],
                            className: 'emoji-icon',
                            popupAnchor: [0, -40]
                        });
                        
                        const marker = L.marker([lat, lng], { icon }).addTo(mapInstance);
                        markers.push(marker);
                    });
                }
            } catch(e) { console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", e); }
        }
        
        setInterval(() => {
            if(document.getElementById('screen-teacher').classList.contains('active')) refresh();
        }, 3000);
    </script>
</body>
</html>